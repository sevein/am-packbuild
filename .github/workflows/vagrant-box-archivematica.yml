name: Archivematica Vagrant box
on:
  workflow_dispatch:
    inputs:
      version:
        description: Version
        required: true
      description:
        description: Description
        required: true
      branch:
        description: Branch where this workflow is executed
        default: "qa/1.x"
      repository:
        description: Repository where this workflow is executed
        default: "https://github.com/artefactual-labs/am-packbuild"
jobs: 
  vagrant-box-atom:
    name: Build and upload
    runs-on: macos-10.15
    env:
      PACKER_CACHE_DIR: ${{ github.workspace }}/.packer_cache
    steps:
    - name: Check out code
      uses: actions/checkout@v2
      with:
        repository: "${{ github.event.inputs.repository }}"
        ref: "${{ github.event.inputs.branch }}"
    - name: Build
      run: |
        cd ${{ github.workspace }}/packer/templates/vagrant-base-ubuntu-18.04-amd64
        packer build -on-error=abort template.json
        cd ${{ github.workspace }}/packer/templates/vagrant-box-archivematica
        packer build -on-error=abort template.json
        mv ${{ github.workspace }}/packer/builds/virtualbox/vagrant-am.box \
          ${{ github.workspace }}/archivematica-vagrant-${{ github.event.inputs.version }}.box
    - name: Upload
      run: |
        ls -lha ${{ github.workspace }}/packer/builds/virtualbox/
